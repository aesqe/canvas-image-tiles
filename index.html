<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="stylesheets/app.css">

    <script type="text/javascript" src="lib/hammer.js"></script>
    <script type="text/javascript" src="javascripts/CanvasShredder.js"></script>

    <title>Split image to tiles with canvas</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Canvas image tiles</h1>
        <h2>Creates tiles from huge images with help of html5 canvas.</h2>

        <section id="downloads">
          <a href="https://github.com/elhigu/canvas-image-tiles/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/elhigu/canvas-image-tiles/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/elhigu/canvas-image-tiles" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h3>
          <a id="creating-tiles-from-huge-images-with-canvas" class="anchor" href="#creating-tiles-from-huge-images-with-canvas-over-60fps" aria-hidden="true">
            <span class="octicon octicon-link"></span>
          </a>
          Sampling tiles from huge images with canvas
        </h3>
        <h4>What it does?</h4>
        <p>
          <ol>
            <li>Reads huge e.g. 250Mpixel image from file</li>
            <li>Stores original data to <em>full size non visible canvas</em> and visible version of image to
              <em>preview canvas</em></li>
            <li>Apply <em>rotate</em>, <em>scale</em>, and <em>translate</em> to be able to read any part
              of original image to 256x256 sized tile.</li>
          </ol>
        </p>
        <p>
          Proof of concept implementation to demonstrate splitting custom map tiles in browser instead of backend.
          Issues/more info found in <a href="https://github.com/elhigu/canvas-image-tiles"><span class="icon"></span>https://github.com/elhigu/canvas-image-tiles</a>
        </p>
        <h4>Challenges</h4>
        <p>
          Transforming huge image could be slow with canvas. So actually we are not doing any transformations
          to source image, but just do inverse transformations for destination canvas to get correct data from
          huge source image. I.e. we rotate, scale and move 256x256 square to top of source and then fill
          it with data from correct position.
        </p>
        <p>
          Read Image() object might be stored to GPU (happened on Chrome) which causes really bad performance
          when destination canvas where tile is written is in host memory. If both source and destination are
          canvases it is more probable that both are in the same memory (both in host or both in GPU).
        </p>
        <p>
          Showing original image in <em>&lt;img&gt;</em> tag and scaling it with CSS is slow for big images.
          This why we are using down scaled <em>preview canvas</em> to adjust image orientation for reading
          pieces.
        </p> 
      </section>
      <section>
        <h3>Try it</h3>
        <p>
          Reads file in, creates / shows preview (max 2048x2048). Preview is used to fit image on top
          of grid which is used to select which part of image should be read to 256x256 tile.
        </p>
        <p>
          Drag from <b>S (Scale)</b>, <b>M (Move)</b>, and <b>R (Rotate)</b> buttons to adjust preview image position.
        </p>

        <span>Choose image:</span>
        <input type="file" id="file-input"><br/>
        <span>Fps:</span>
        <span id="fps"></span><br/>
        <span>Image size:</span>
        <span id="image-info"></span><br/>

        <span>Click area below to select tile position</span>
        <div id="preview-area">
          <div id="select-position"></div>
          <div class="buttons">
            <div class="ctrl-btn move">M</div>
            <div class="ctrl-btn rotate">R</div>
            <div class="ctrl-btn scale">S</div>
          </div>
          <canvas id="dst-canvas" width="256" height="256"></canvas>
        </div>
        <canvas id="tile-out" width="256" height="256"></canvas>
      </section>
    </div>
    <script type="text/javascript" src="javascripts/app.js"></script>
 
  </body>
</html>
